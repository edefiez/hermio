# Implementation Plan: User Account & Authentication

**Branch**: `002-user-account-auth` | **Date**: December 7, 2025 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-user-account-auth/spec.md`

**Note**: This plan is generated by the `/speckit.plan` command following the Hermio constitution and Symfony 8 best practices.

## Summary

This feature implements a complete user authentication system including registration, login, password reset, session management, and profile management. The implementation follows Symfony Security best practices using the Security component, Doctrine ORM for user persistence, and Symfony Mailer for email notifications. The system enforces strong password policies, implements rate limiting for brute force protection, and maintains comprehensive audit logging for security events.

**Primary Requirement**: Provide secure user authentication and account management capabilities for the Hermio application.

**Technical Approach**: Leverage Symfony's Security component with custom authenticator, Doctrine User entity implementing UserInterface, token-based email verification and password reset using secure single-use tokens, session-based authentication with configurable timeout, and Twig templates for all user-facing forms.

## Technical Context

**Language/Version**: PHP 8.4  
**Primary Dependencies**: Symfony 8.0 (Security, Doctrine, Mailer, Validator, Form, Twig)  
**Storage**: Doctrine ORM with migrations (database vendor agnostic - configured via DATABASE_URL)  
**Testing**: PHPUnit with Symfony test framework, Doctrine test fixtures  
**Target Platform**: Web application (server-side rendered with Twig + Stimulus for interactivity)  
**Project Type**: Web application (Symfony monolith with frontend/backend integrated)  
**Performance Goals**: 
- Login/registration response < 200ms (excluding email sending)
- Support 100+ concurrent authenticated sessions
- Password hashing using bcrypt/argon2 (configured in security.yaml)

**Constraints**: 
- Must follow Symfony security best practices
- All passwords must be hashed (never plain text)
- Email verification and password reset tokens must expire within 24 hours
- Rate limiting: max 5 failed login attempts per 15 minutes
- Session timeout: 2 hours of inactivity
- All forms must include CSRF protection
- All UI text must be translatable (i18n)

**Scale/Scope**: 
- Initial deployment for small to medium user base (< 10,000 users)
- 5 user stories with P1-P3 priorities
- 20 functional requirements
- 4 Doctrine entities (User, EmailVerificationToken, PasswordResetToken, AuthenticationLog)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Architecture Compliance

âœ… **Clean Symfony Architecture**: 
- Controllers will remain thin (handle HTTP, delegate to services)
- Business logic in dedicated Services (`UserRegistrationService`, `AuthenticationService`, `PasswordResetService`)
- Data access via Doctrine Repositories (`UserRepository`)
- Security via Symfony Security component and custom Authenticator
- Flow: `Controller â†’ Service â†’ Repository â†’ Entity`

âœ… **Twig-Driven Frontend**:
- All forms rendered via Twig templates
- No React/Vue/Svelte - pure Symfony forms with Twig
- Stimulus controllers for client-side validation and UX enhancements only
- Translation keys for all UI text

âœ… **Doctrine ORM as Single Source of Truth**:
- User, EmailVerificationToken, PasswordResetToken, AuthenticationLog as Doctrine entities
- All persistence through Repositories
- Schema changes via Doctrine migrations
- No raw SQL (unless justified by performance)

âœ… **Security & Authentication Rules**:
- `security.yaml` configuration for firewall and access control
- PasswordHasher for credential hashing
- Custom Authenticator for form login
- Role hierarchy: ROLE_USER (default for authenticated users)
- Authorization via `#[IsGranted('IS_AUTHENTICATED_FULLY')]` and access_control
- Session-based authentication (Symfony default)

### Asset Pipeline Compliance

âœ… **Webpack Encore**:
- Existing structure maintained (`assets/js/app.js`, `assets/styles/app.scss`)
- Stimulus controllers for form validation/UX (`assets/controllers/`)
- No additional build tools introduced
- Standard entrypoints loaded via `encore_entry_link_tags()` and `encore_entry_script_tags()`

### i18n Compliance

âœ… **Symfony Translation**:
- All UI text uses `{{ 'key'|trans }}` in Twig
- Translation files: `translations/messages.en.yaml`, `translations/messages.fr.yaml`
- Flash messages, validation errors, form labels all translatable
- No hardcoded strings in templates or controllers

### Coding Standards

âœ… **PSR-12 & Symfony Conventions**:
- Proper namespacing: `App\Controller`, `App\Service`, `App\Entity`, `App\Repository`, `App\Security`
- Strong typing (PHP 8.4 type hints)
- Directory structure: `src/Controller/`, `src/Service/`, `src/Entity/`, `src/Repository/`, `src/Security/`, `src/Form/`

### Verdict

ðŸŸ¢ **PASS** - All constitution requirements are met. No violations. Ready to proceed to Phase 0 research.

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
â”œâ”€â”€ plan.md              # This file (/speckit.plan command output)
â”œâ”€â”€ research.md          # Phase 0 output (/speckit.plan command)
â”œâ”€â”€ data-model.md        # Phase 1 output (/speckit.plan command)
â”œâ”€â”€ quickstart.md        # Phase 1 output (/speckit.plan command)
â”œâ”€â”€ contracts/           # Phase 1 output (/speckit.plan command)
â””â”€â”€ tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)
<!--
  ACTION REQUIRED: Replace the placeholder tree below with the concrete layout
  for this feature. Delete unused options and expand the chosen structure with
  real paths (e.g., apps/admin, packages/something). The delivered plan must
  not include Option labels.
-->

```text
# [REMOVE IF UNUSED] Option 1: Single project (DEFAULT)
src/
â”œâ”€â”€ models/
â”œâ”€â”€ services/
â”œâ”€â”€ cli/
â””â”€â”€ lib/

tests/
â”œâ”€â”€ contract/
â”œâ”€â”€ integration/
â””â”€â”€ unit/

# [REMOVE IF UNUSED] Option 2: Web application (when "frontend" + "backend" detected)
backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ services/
â”‚   â””â”€â”€ api/
â””â”€â”€ tests/

frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ pages/
â”‚   â””â”€â”€ services/
â””â”€â”€ tests/

# [REMOVE IF UNUSED] Option 3: Mobile + API (when "iOS/Android" detected)
api/
â””â”€â”€ [same as backend above]

ios/ or android/
â””â”€â”€ [platform-specific structure: feature modules, UI flows, platform tests]
```

**Structure Decision**: [Document the selected structure and reference the real
directories captured above]

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| [e.g., 4th project] | [current need] | [why 3 projects insufficient] |
| [e.g., Repository pattern] | [specific problem] | [why direct DB access insufficient] |
