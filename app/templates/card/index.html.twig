{% extends 'base_admin.html.twig' %}

{% block title %}{{ 'card.list.title'|trans }} - Hermio{% endblock %}

{% block page_title %}{{ 'card.list.title'|trans }}{% endblock %}

{% block admin_content %}
<div class="container" style="padding-bottom: 3rem;">
    <div class="card">
        <div class="card-header">
            <div class="row align-items-center">
                <div class="col-md-6 col-12">
                    <h2>{{ 'card.list.title'|trans }}</h2>
                    <p class="mb-0">
                        <strong>{{ 'account.quota.usage'|trans }}:</strong>
                        {{ currentUsage }} /
                        {% if quotaLimit %}
                            {{ quotaLimit }} {{ 'account.quota.cards'|trans }}
                        {% else %}
                            {{ 'account.quota.unlimited'|trans }}
                        {% endif %}
                    </p>
                </div>
                <div class="col-md-6 col-12 mt-2 mt-md-0">
                    {% if canCreateMore %}
                        <div class="d-flex justify-content-end">
                            <a href="{{ path('app_card_create') }}" class="btn btn-primary">{{ 'card.create.button'|trans }}</a>
                        </div>
                    {% else %}
                        <div class="alert alert-warning mb-0">
                            {{ 'card.quota.exceeded'|trans }}
                            <a href="{{ path('app_account_my_plan') }}">{{ 'account.view_plan_details'|trans }}</a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# Search Bar #}
    {% if totalCards > 0 %}
        <div class="card mt-3">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8 col-12">
                        <input type="text" 
                               id="card-search" 
                               class="form-control" 
                               placeholder="{{ 'card.search.placeholder'|trans|default('Search cards by name, email, or company...') }}"
                               aria-label="{{ 'card.search.label'|trans|default('Search cards') }}">
                    </div>
                    <div class="col-md-4 col-12 mt-2 mt-md-0">
                        <span id="card-count" class="text-muted">
                            {{ 'card.count'|trans|default('Total cards') }}: <strong id="card-total">{{ totalCards }}</strong>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    {# Cards Container #}
    <div class="row" id="cards-container">
        {% if cards|length > 0 %}
            {% include 'card/_card_list.html.twig' %}
        {% else %}
            <div class="col-12 mt-4">
                <div class="alert alert-info" id="no-cards-message">
                    <p>{{ 'card.list.empty'|trans }}</p>
                    {% if canCreateMore %}
                        <a href="{{ path('app_card_create') }}" class="btn btn-primary">{{ 'card.create.button'|trans }}</a>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </div>

    {# Loading Indicator #}
    <div class="text-center mt-4" id="loading-indicator" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">{{ 'common.loading'|trans|default('Loading...') }}</span>
        </div>
    </div>

    {# No Results Message Template (hidden) #}
    <div id="no-results-template" style="display: none;">
        <div class="col-12 mt-4">
            <div class="alert alert-info">
                <p>{{ 'card.search.no_results'|trans|default('No cards found matching your search.') }}</p>
            </div>
        </div>
    </div>

    {# Infinite Scroll Trigger #}
    <div id="scroll-trigger" style="height: 1px;" data-offset="{{ cards|length }}" data-has-more="{{ totalCards > cards|length ? 'true' : 'false' }}"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('card-search');
    const cardsContainer = document.getElementById('cards-container');
    const scrollTrigger = document.getElementById('scroll-trigger');
    const loadingIndicator = document.getElementById('loading-indicator');
    const cardTotal = document.getElementById('card-total');
    const noResultsTemplate = document.getElementById('no-results-template');
    const apiUrl = {{ path('app_card_api_search')|json_encode|raw }};
    
    let currentQuery = '';
    let currentOffset = 0;
    let hasMore = scrollTrigger ? scrollTrigger.dataset.hasMore === 'true' : false;
    let isLoading = false;
    let searchTimeout = null;

    // Search functionality with debounce
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(function() {
                currentQuery = searchInput.value.trim();
                currentOffset = 0;
                hasMore = true;
                loadCards(true);
            }, 300); // 300ms debounce
        });
    }

    // Infinite scroll
    if (scrollTrigger) {
        const observer = new IntersectionObserver(function(entries) {
            entries.forEach(function(entry) {
                if (entry.isIntersecting && hasMore && !isLoading) {
                    loadCards(false);
                }
            });
        }, {
            rootMargin: '100px'
        });

        observer.observe(scrollTrigger);
    }

    function loadCards(replace) {
        if (isLoading) return;
        
        isLoading = true;
        if (loadingIndicator) {
            loadingIndicator.style.display = 'block';
        }

        const url = new URL(apiUrl, window.location.origin);
        if (currentQuery) {
            url.searchParams.set('q', currentQuery);
        }
        if (!replace) {
            url.searchParams.set('offset', currentOffset);
        }

        fetch(url)
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(function(html) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newCards = doc.querySelectorAll('.card-item');
                
                if (replace) {
                    cardsContainer.innerHTML = '';
                    currentOffset = 0;
                }

                if (newCards.length > 0) {
                    newCards.forEach(function(card) {
                        cardsContainer.appendChild(card);
                    });
                    currentOffset += newCards.length;
                } else if (replace) {
                    // No results - clone and append the no results template
                    if (noResultsTemplate) {
                        const noResults = noResultsTemplate.cloneNode(true);
                        noResults.style.display = '';
                        noResults.id = '';
                        cardsContainer.appendChild(noResults.firstElementChild);
                    }
                }

                // Update hasMore flag
                const hasMoreAttr = doc.querySelector('[data-has-more]');
                hasMore = hasMoreAttr ? hasMoreAttr.dataset.hasMore === 'true' : false;
                
                // Update total count
                const totalAttr = doc.querySelector('[data-total-cards]');
                if (totalAttr && cardTotal) {
                    cardTotal.textContent = totalAttr.dataset.totalCards;
                }

                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                isLoading = false;
            })
            .catch(function(error) {
                console.error('Error loading cards:', error);
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                isLoading = false;
            });
    }
});
</script>
{% endblock %}

